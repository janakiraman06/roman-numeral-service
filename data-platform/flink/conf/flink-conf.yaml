# ============================================
# Apache Flink Configuration
# ============================================
# Optimized for Bronze layer streaming ingestion
# with exactly-once semantics and fault tolerance
#
# Compatibility Matrix (verified from official docs):
# - Flink: 1.18.1
# - Iceberg: 1.5.2 (iceberg-flink-runtime-1.18)
# - Kafka Connector: 3.0.2-1.18
# - Java: 17 (recommended by Flink 1.18+)
# - Hive Metastore: 3.1.3 (catalog only)
#
# References:
# - https://nightlies.apache.org/flink/flink-docs-release-1.18/
# - https://iceberg.apache.org/docs/latest/flink/
# ============================================

# JobManager Configuration
jobmanager.rpc.address: flink-jobmanager
jobmanager.rpc.port: 6123
jobmanager.memory.process.size: 1600m

# TaskManager Configuration
taskmanager.numberOfTaskSlots: 4
taskmanager.memory.process.size: 2048m
taskmanager.memory.managed.fraction: 0.4

# Parallelism
parallelism.default: 2

# ============================================
# State Backend (RocksDB)
# ============================================
# RocksDB enables efficient state management
# for deduplication and windowing
state.backend: rocksdb
state.backend.rocksdb.localdir: /tmp/flink-rocksdb
state.backend.incremental: true
state.backend.rocksdb.checkpoint.transfer.thread.num: 4

# ============================================
# Checkpointing (Exactly-Once Semantics)
# ============================================
# Checkpoints enable failure recovery with exactly-once
execution.checkpointing.interval: 60000
execution.checkpointing.mode: EXACTLY_ONCE
execution.checkpointing.min-pause: 30000
execution.checkpointing.timeout: 600000
execution.checkpointing.max-concurrent-checkpoints: 1
execution.checkpointing.externalized-checkpoint-retention: RETAIN_ON_CANCELLATION

# Checkpoint storage (MinIO/S3)
state.checkpoints.dir: s3://lakehouse/flink/checkpoints
state.savepoints.dir: s3://lakehouse/flink/savepoints

# ============================================
# Restart Strategy (Failure Recovery)
# ============================================
# Fixed delay restart for transient failures
restart-strategy: fixed-delay
restart-strategy.fixed-delay.attempts: 3
restart-strategy.fixed-delay.delay: 30s

# ============================================
# S3/MinIO Configuration
# ============================================
# Path-style access required for MinIO
s3.endpoint: http://minio:9000
s3.path-style-access: true
s3.access-key: minioadmin
s3.secret-key: minioadmin123

# ============================================
# Kafka Consumer Configuration
# ============================================
# Used by FlinkKafkaConsumer
flink.partition-discovery.interval-millis: 30000

# ============================================
# Metrics and Logging
# ============================================
metrics.reporter.prom.class: org.apache.flink.metrics.prometheus.PrometheusReporter
metrics.reporter.prom.port: 9249

# ============================================
# Web UI
# ============================================
web.submit.enable: true
web.cancel.enable: true
web.upload.dir: /opt/flink/upload

# ============================================
# High Availability (for production)
# ============================================
# Disabled for local development
# high-availability: zookeeper
# high-availability.zookeeper.quorum: zookeeper:2181
# high-availability.storageDir: s3://lakehouse/flink/ha

